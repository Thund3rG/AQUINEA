<!doctype html>
<html lang="es">
<head>

<script>
if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
  const newURL = 'https://' + location.host + location.pathname + location.search + location.hash;
  window.location.replace(newURL);
}
</script>

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aquinea Control v2.0</title>
<meta name="description" content="Aquinea Control — panel de control inteligente" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root{
  --bg1:#e6fff9; --bg2:#c0f3ea;
  --accent1:#00bfa6; --accent2:#0097a7;
  --deep:#0f766e; --muted:#607d8b; --card:#ffffff;
}

    ============================================================
    1. CONFIGURACIÓN BÁSICA DE FAVICON (Icono del navegador)
    ============================================================
    -->
    <!-- Ícono estándar (48x48) - ¡FORZANDO RECARGA! -->
    <link ref="icon" href="/assets/favicon.ico?v=2" sizes="48x48">
    <!-- Ícono vectorial SVG (mejor calidad) - ¡FORZANDO RECARGA! -->
    <link ref="icon" href="/assets/icon.svg?v=2" sizes="any" type="image/svg+xml">
    <!-- Icono de alta resolución para dispositivos Apple (180x180 recomendado) - ¡FORZANDO RECARGA! -->
    <link ref="apple-touch-icon" href="/assets/apple-touch-icon.png?v=2">


    <!--
    ============================================================
    2. CONFIGURACIÓN PWA/HOMESCREEN (Android/iOS "Agregar al inicio")
    ============================================================
    -->
    <!-- Link al archivo manifest.json (REQUERIDO para Android/PWA) - ¡FORZANDO RECARGA! -->
    <link ref="manifest" href="/manifest.json?v=2">

    <!-- Meta tags específicas para iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="AQUINEA">
    <!-- Color de la barra de estado superior de iOS -->
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <!-- Color principal (theme-color): Cyan Pastel Apagado -->
    <meta name="theme-color" content="#80CBC4">

    <!--
    ============================================================
    3. CONFIGURACIÓN OPEN GRAPH (OG) PARA REDES SOCIALES
    ============================================================
    -->
    <meta property="og:title" content="AQUINEA: Cada Gota Cuenta">
    <meta property="og:description" content="Maneja tus dispositivos AQUINEA desde tu celular">
    <!-- Imagen de preview (OG) - ¡FORZANDO RECARGA! -->
    <meta property="og:image" content="https://aquinea.vercel.app/assets/social-share-1200x630.png?v=2">
    <meta property="og:url" content="https://aquinea.vercel.app/">
    <meta property="og:type" content="website">

    <style>
        /* Estilos básicos de la página */
        body {
            font-family: sans-serif;
            /* Color de Fondo: Gris (#F3F4F6) */
            background-color: #F3F4F6;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            color: #1f2937;
        }
        .container {
            max-width: 600px;
            background-color: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        h1 {
            /* Color Principal: Cyan Pastel Apagado (#80CBC4) */
            color: #80CBC4;
            font-size: 1.875rem;
        }


html,body{height:100%;margin:0;padding:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
.app-wrap{position:fixed;inset:0;margin:auto;max-width:980px;background:linear-gradient(180deg,white,#fbfffe);border-radius:14px;overflow:hidden;box-shadow:0 20px 50px rgba(13,33,27,0.12);display:flex;flex-direction:column;}
.header{display:flex;align-items:center;gap:12px;padding:14px 18px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;}
.logo-box{width:120px;height:120px;border-radius:12px;background:rgba(255,255,255,0.12);display:grid;place-items:center;box-shadow:0 8px 20px rgba(15,119,110,0.12);}
/* Se aplica la rotación de 180 grados al SVG de la gota de agua */
.logo-box svg{width:110px;height:110px;border-radius:8px;object-fit:contain;fill:white;transform: rotate(180deg);} 

.title{font-size:18px;font-weight:700;margin:0;}
.subtitle{font-size:12px;opacity:0.95;margin-top:4px;}
.views{flex:1;position:relative;min-height:560px;}
.view{position:absolute;inset:0;transition:transform .38s cubic-bezier(.22,.9,.32,1),opacity .28s;overflow:auto;padding:18px;}
.centered{transform:translateX(0);opacity:1;pointer-events:auto;}
.hidden-view{opacity:0;pointer-events:none;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 20px rgba(10,20,18,0.06);}
.stat-title{font-size:13px;color:var(--muted);margin-bottom:8px;}
.stat-value{font-size:20px;font-weight:700;color:var(--deep);}
.dial-wrap{display:flex;flex-direction:column;align-items:center;gap:8px;padding:8px;}
.dial{width:240px;height:240px;border-radius:50%;display:grid;place-items:center;position:relative;}
.dial svg{width:240px;height:240px;}
.slider{width:100%;margin-top:8px;}
.btn-main{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;border:none;border-radius:12px;padding:12px 14px;font-weight:700;box-shadow:0 8px 20px rgba(0,191,166,0.18);cursor:pointer;}
.btn-ghost{background:#eceff1;border-radius:10px;padding:10px;font-weight:700;color:#37474f;border:none;cursor:pointer;}
.icon-btn{background:rgba(255,255,255,0.12);border:none;border-radius:8px;padding:8px;display:inline-flex;align-items:center;justify-content:center;color:white;cursor:pointer;}
.small-muted{font-size:12px;color:var(--muted);}
.footer-note{font-size:12px;color:var(--muted);text-align:center;margin-top:12px;}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:120;}
.modal.show{display:flex;}
.modal .panel{width:92vw;max-width:420px;background:white;border-radius:12px;padding:14px;max-height:82vh;overflow:auto;box-shadow:0 16px 40px rgba(0,0,0,0.25);}
@media(min-width:900px){ .dial{width:320px;height:320px}.dial svg{width:320px;height:320px}.logo-box{width:140px;height:140px}.logo-box svg{width:130px;height:130px} .app-wrap{border-radius:18px} }
</style>
</head>
<body>
<div class="app-wrap" role="application" aria-label="Aquinea Control">
  <header class="header">
    <button id="btnHome" class="icon-btn" title="Inicio" aria-label="Inicio" style="margin-right:6px;display:none;">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="white" viewBox="0 0 24 24"><path d="M12 3l10 9h-3v9h-6v-6h-2v6H5v-9H2z"/></svg>
    </button>

    <div class="logo-box" aria-hidden="true">
      <svg xmlns="http://www.w3.org/2000/svg" width="110" height="110" viewBox="0 0 24 24">
        <path d="M12 2c-5.333 0-10 4.667-10 10 0 4.667 6 12 10 12s10-7.333 10-12c0-5.333-4.667-10-10-10zm0 18c-2.333-2.667-4-5.333-4-8s1.778-4 4-4 4 1.333 4 4c0 2.667-1.667 5.333-4 8z"/>
      </svg>
    </div>

    <div style="flex:1;">
      <div class="title" id="deviceTitle">AQUINEA</div>
      <div class="subtitle small-muted" id="deviceSubtitle">Sin dispositivo seleccionado</div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;">
      <div style="text-align:right;color:rgba(255,255,255,0.95);font-size:13px;">
        <div id="connText" style="color:#d32f2f;">Desconectado</div> 
        <div id="modeLabel" style="font-size:11px;opacity:0.9">—</div>
      </div>
    </div>
  </header>

  <main class="views">
    <section id="view-welcome" class="view centered">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h2 style="margin:0;font-size:20px;font-weight:800;color:#0f766e;">Dispositivos</h2>
        <div style="display:flex;gap:8px;">
          <button id="btnAdd" class="btn-main">Agregar</button>
          <button id="btnScanOpen" class="btn-ghost">Escanear QR</button>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px;">
        <div><div class="small-muted">Dispositivos guardados</div><div id="deviceList" style="margin-top:8px;max-height:260px;overflow:auto;"></div></div>
      </div>

      <div class="footer-note">Aquinea — Conserva agua y energía ♻️</div>
    </section>

    <section id="view-panel" class="view hidden-view">
      <div style="display:flex;flex-direction:column;gap:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:700;color:var(--deep);" id="panelTitle">Panel</div>
            <div class="small-muted" id="panelSubtitle">Control del dispositivo</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button id="btnHomePanel" class="icon-btn" title="Inicio" aria-label="Inicio" style="display:none;">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="white" viewBox="0 0 24 24"><path d="M12 3l10 9h-3v9h-6v-6h-2v6H5v-9H2z"/></svg>
            </button>
            <button id="toggleLocalAlarm" class="btn-ghost" title="Alternar alarma local" style="display:inline-block;"></button>
          </div>
        </div>

        <div class="grid-2" style="margin-bottom:12px;">
          <div class="card">
            <div class="stat-title">Estado</div>
            <div class="stat-value" id="panelState">—</div>
            <div class="small-muted" style="margin-top:8px" id="panelLast">—</div>
          </div>
          <div class="card">
            <div class="stat-title">Sensor</div>
            <div id="panelTemp" style="font-size:28px;font-weight:800;color:#d35400">--°C</div>
            <div class="small-muted" style="margin-top:6px">Lectura actual</div>
          </div>
        </div>

        <div class="card dial-wrap">
          <div class="dial">
            <svg id="tempDial" viewBox="0 0 200 200">
              <defs>
                <linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#2196F3"/>
                  <stop offset="33%" stop-color="#00BCD4"/>
                  <stop offset="66%" stop-color="#4CAF50"/>
                  <stop offset="100%" stop-color="#FF5722"/>
                </linearGradient>
              </defs>
              <circle cx="100" cy="100" r="80" stroke="#eee" stroke-width="16" fill="none"/>
              <g transform="rotate(90,100,100)">
                <circle id="arc" cx="100" cy="100" r="80" stroke="url(#g1)" stroke-width="16" fill="none" stroke-linecap="round" stroke-dasharray="0 502" stroke-dashoffset="0"/>
              </g>
              <text x="100" y="108" text-anchor="middle" style="font-size:28px;font-weight:800;fill:#0f766e" id="dialCenter">--°C</text>
            </svg>
          </div>

          <input id="tempRange" type="range" min="20" max="50" value="38" class="slider" style="width:100%;margin-top:12px;"/>
          <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:6px">
            <div>20°C</div><div>35°C</div><div>50°C</div>
          </div>

          <div style="display:flex;gap:10px;width:100%;margin-top:10px;">
            <button id="preset32" class="btn-ghost" style="flex:1;background:#e8f8f5;">32°C</button>
            <button id="preset38" class="btn-ghost" style="flex:1;background:#eefef6;">38°C</button>
            <button id="preset42" class="btn-ghost" style="flex:1;background:#fff7ef;">42°C</button>
          </div>
        </div>

        <div style="display:flex;gap:12px;">
          <button id="activateBtn" class="btn-main">Activar Sistema</button>
          <button id="deactivateBtn" class="btn-ghost">Apagar Sistema</button>
        </div>

        <div class="card" style="margin-top:12px;">
          <div style="font-weight:700;color:var(--deep)">Ahorro de Agua</div>
          <div style="font-size:13px;color:var(--muted);margin-top:6px">Hoy: <span id="savedToday">—</span> | Este mes: <span id="savedMonth">—</span></div>
        </div>
      </div>
    </section>
  </main>
</div>

<div id="modalAdd" class="modal">
  <div class="panel">
    <h3 style="margin:0 0 8px 0;font-weight:800;color:var(--deep)">Agregar dispositivo</h3>
    <p class="small-muted" style="margin:0 0 8px 0">Introduce el Alias y el ID (Host) del dispositivo.</p>
    <input id="aliasInput" placeholder="Alias (Ej: Regadera Principal)" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef0;margin-bottom:10px"/>
    <input id="hostInput" placeholder="ID del dispositivo (aquinea-1234.local o IP)" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef0;margin-bottom:10px"/>
    
    <div style="display:flex;gap:8px;margin-bottom:8px;">
      <button id="modalScan" class="btn-main" style="flex:1;">Escanear QR</button>
      <button id="modalSave" class="btn-ghost" style="flex:1;">Guardar</button>
    </div>
    <div id="qrReaderHolder" style="display:none;">
      <div class="qr-reader" id="qrReader">Cámara QR</div>
      <div style="text-align:right;margin-top:8px;"><button id="modalStopScan" class="btn-ghost">Cerrar cámara</button></div>
    </div>
    <div style="text-align:right;margin-top:10px;"><button id="modalClose" class="btn-ghost">Cerrar</button></div>
  </div>
</div>

<script>
/* Aquinea Control v2.0 - Código Modificado */

const POLL_MS = 3000;
// Nuevo: localAlarmEnabled para controlar si la alarma local debe sonar
const app = { devices: [], current: null, pollTimer: null, localAlarmTimer: null, audioCtx: null, localAlarmEnabled: true }; 

const $ = id => document.getElementById(id);

// Storage helpers
function loadDevices(){ try{ return JSON.parse(localStorage.getItem('aquinea_devices')||'[]'); }catch(e){ return []; } }
function saveDevices(){ localStorage.setItem('aquinea_devices', JSON.stringify(app.devices)); }

// Render device list
function renderDeviceList(){
  const list = $('deviceList'); list.innerHTML = '';
  if(app.devices.length === 0){
    const el = document.createElement('div'); el.textContent = 'No hay dispositivos guardados'; el.className='small-muted'; el.style.textAlign='center';
    list.appendChild(el); return;
  }
  app.devices.forEach((d,i)=>{
    const statusText = 'Desconectado';
    const statusColor = '#d32f2f'; // Rojo para Desconectado

    const row = document.createElement('div'); row.className='card'; row.style.marginBottom='8px';
    row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div style="font-weight:700;color:var(--deep)">${d.label||d.host}</div>
        <div style="font-size:12px;color:var(--muted)">${d.host}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <div style="font-size:12px;font-weight:700;color:${statusColor}">${statusText}</div>
        <button class="btn-main" data-index="${i}">Abrir</button>
        
        <button class="btn-ghost" data-remove="${i}" title="Eliminar" aria-label="Eliminar dispositivo" style="padding: 10px 12px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2" style="color:#d32f2f;"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        </button>
      </div>
    </div>`;
    list.appendChild(row);
    row.querySelector('[data-index]').addEventListener('click', ()=>{ selectDevice(i); openPanel(); });
    row.querySelector('[data-remove]').addEventListener('click', ()=>{ app.devices.splice(i,1); saveDevices(); renderDeviceList(); });
  });
}

// Select device and set header
function selectDevice(idx){
  app.current = app.devices[idx];
  // MODIFICACIÓN: Mostrar el alias/host del dispositivo SOLO en la vista de panel
  $('deviceTitle').textContent = app.current.label || app.current.host;
  $('deviceSubtitle').textContent = app.current.host;
  
  $('connText').textContent = 'Conectando...';
  $('connText').style.color = 'white'; 
  $('modeLabel').textContent = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)? 'Móvil' : 'Equipo';
}

// Views
const viewWelcome = $('view-welcome'), viewPanel = $('view-panel');
function showView(name){
  if(name === 'welcome'){
    viewWelcome.classList.add('centered'); viewWelcome.classList.remove('hidden-view');
    viewPanel.classList.remove('centered'); viewPanel.classList.add('hidden-view');
    
    $('btnHome') && ($('btnHome').style.display = 'none');
    $('btnHomePanel') && ($('btnHomePanel').style.display = 'none');
    stopPolling();
    stopLocalBeepLoop(); // Detener alarma al volver a inicio

    // MODIFICACIÓN: Restablecer el título a "AQUINEA"
    $('deviceTitle').textContent = 'AQUINEA';
    $('deviceSubtitle').textContent = 'Sin dispositivo seleccionado';
    
    // Restablecer el color de conexión a rojo al volver a la lista
    $('connText').textContent = 'Desconectado';
    $('connText').style.color = '#d32f2f'; // Rojo
  } else {
    viewPanel.classList.add('centered'); viewPanel.classList.remove('hidden-view');
    viewWelcome.classList.remove('centered'); viewWelcome.classList.add('hidden-view');
    
    $('btnHome') && ($('btnHome').style.display = 'inline-flex');
    $('btnHomePanel') && ($('btnHomePanel').style.display = 'inline-flex');
    updateAlarmButton(); // Asegurar que el botón de alarma tenga el texto correcto
  }
}

// Open panel and start polling
function openPanel(){ showView('panel'); startPolling(); }

// Arc update
function updateArc(value, min, max){
  const circle = document.getElementById('arc');
  const radius = 80;
  const circumference = 2 * Math.PI * radius;
  const pct = Math.max(0, Math.min(1, (value - min) / (max - min)));
  const dash = pct * circumference;
  circle.setAttribute('stroke-dasharray', `${dash} ${circumference - dash}`);
  circle.setAttribute('stroke-dashoffset', circumference - dash);
  document.getElementById('dialCenter').textContent = Math.round(value) + '°C';
}

// Polling /status
async function fetchStatusOnce(){
  if(!app.current) return;
  try{
    const resp = await fetch((app.current.host.startsWith('http')?app.current.host:'http://'+app.current.host) + '/status', {cache:'no-store'});
    if(!resp.ok) throw new Error('no ok');
    const j = await resp.json();
    const temp = Number(j.tempActual ?? j.temp ?? NaN);
    const desired = Number(j.tempObjetivo ?? j.tempDeseada ?? Number($('tempRange')?.value || 38));
    $('panelTemp').textContent = isNaN(temp)? '--°C' : temp.toFixed(1) + '°C';
    $('panelState').textContent = j.sistemaActivo !== undefined ? (j.sistemaActivo ? 'Activo' : 'Apagado') : (j.state ?? '—');
    $('panelLast').textContent = new Date().toLocaleTimeString();
    
    $('connText').textContent = 'Conectado';
    $('connText').style.color = '#4CAF50'; // Verde
    
    const val = isNaN(desired) ? Number($('tempRange')?.value || 38) : desired;
    if($('tempRange')){ $('tempRange').value = val; updateArc(val,20,50); }
    
    // If reached target: request device alert and start local beep loop
    if(!isNaN(temp) && val>0 && temp >= val){
      fetch((app.current.host.startsWith('http')?app.current.host:'http://'+app.current.host) + '/trigger_alert').catch(()=>{});
      // MODIFICACIÓN: Iniciar beep solo si la alarma local está activada por el usuario
      if (app.localAlarmEnabled) {
        startLocalBeepLoop();
      }
    }
  }catch(e){
    $('connText').textContent = 'Desconectado';
    $('connText').style.color = '#d32f2f'; // Rojo
  }
}
function startPolling(){ stopPolling(); fetchStatusOnce(); app.pollTimer = setInterval(fetchStatusOnce, POLL_MS); }
function stopPolling(){ if(app.pollTimer){ clearInterval(app.pollTimer); app.pollTimer = null; } }

// Local beep alarm (30s loop)
function ensureAudioCtx(){ if(app.audioCtx) return app.audioCtx; try{ const AC = window.AudioContext || window.webkitAudioContext; app.audioCtx = new AC(); }catch(e){ app.audioCtx = null; } return app.audioCtx; }
function playBeepOnce(){ const ctx = ensureAudioCtx(); if(!ctx){ if(navigator.vibrate) navigator.vibrate([200,40,200]); return; } if(ctx.state === 'suspended'){ ctx.resume().catch(()=>{}); } const o = ctx.createOscillator(); const g = ctx.createGain(); o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.06; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>o.stop(),260); }
function startLocalBeepLoop(){ 
    if(!app.localAlarmEnabled) return; // Se agregó esta comprobación
    if(app.localAlarmTimer) return; 
    playBeepOnce(); 
    app.localAlarmTimer = setInterval(playBeepOnce, 30000); 
}
function stopLocalBeepLoop(){ if(app.localAlarmTimer){ clearInterval(app.localAlarmTimer); app.localAlarmTimer = null; } }

// MODIFICACIÓN: Función para actualizar el texto y color del botón de alarma
function updateAlarmButton(){
  const btn = $('toggleLocalAlarm');
  if(!btn) return;
  if(app.localAlarmEnabled){
    btn.textContent = 'Desactivar Alarma Local';
    btn.style.background = '#ffeb3b'; // Amarillo para indicar que está activa
  } else {
    btn.textContent = 'Activar Alarma Local';
    btn.style.background = '#eceff1'; // Gris para indicar que está inactiva
  }
}

// UI wiring
$('btnAdd').addEventListener('click', ()=>{ $('modalAdd').classList.add('show'); $('aliasInput').value=''; $('hostInput').value=''; });

// === CÓDIGO CORREGIDO ===
$('btnScanOpen').addEventListener('click', ()=>{
  $('modalAdd').classList.add('show');
  if ($('qrReaderHolder')) $('qrReaderHolder').style.display = 'block';
  startQrScanner(); // usa lector QR interno
});
// =========================

$('modalClose').addEventListener('click', ()=>{ $('modalAdd').classList.remove('show'); stopQrScanner(); $('qrReaderHolder') && ($('qrReaderHolder').style.display='none'); });

// MODIFICACIÓN: Lógica de guardado con Alias y Host separados
$('modalSave').addEventListener('click', ()=>{ 
  const h = $('hostInput').value.trim();
  const l = $('aliasInput').value.trim(); // Alias es opcional
  if(!h) return alert('Introduce el ID del dispositivo (Host)');
  app.devices.push({host:h,label:l||h}); 
  saveDevices(); 
  renderDeviceList(); 
  $('modalAdd').classList.remove('show'); 
  $('qrReaderHolder') && ($('qrReaderHolder').style.display='none'); 
});

$('modalStopScan') && $('modalStopScan').addEventListener('click', ()=>{ stopQrScanner(); $('qrReaderHolder').style.display='none'; });

// Range & presets
$('tempRange') && $('tempRange').addEventListener('input', (e)=>{ const v = Number(e.target.value); updateArc(v,20,50); fetchSetTemp(v); });
$('preset32') && $('preset32').addEventListener('click', ()=>{ $('tempRange').value=32; updateArc(32,20,50); fetchSetTemp(32); });
$('preset38') && $('preset38').addEventListener('click', ()=>{ $('tempRange').value=38; updateArc(38,20,50); fetchSetTemp(38); });
$('preset42') && $('preset42').addEventListener('click', ()=>{ $('tempRange').value=42; updateArc(42,20,50); fetchSetTemp(42); });

// Activate / Deactivate
$('activateBtn').addEventListener('click', ()=>{ if(!app.current) return alert('Selecciona un dispositivo'); fetch((app.current.host.startsWith('http')?app.current.host:'http://'+app.current.host) + '/toggle_system').then(()=>fetchStatusOnce()); });
$('deactivateBtn').addEventListener('click', ()=>{ if(!app.current) return alert('Selecciona un dispositivo'); fetch((app.current.host.startsWith('http')?app.current.host:'http://'+app.current.host) + '/toggle_system').then(()=>fetchStatusOnce()); });

// Home button behavior: visible only in panel
$('btnHome') && $('btnHome').addEventListener('click', ()=>{ showView('welcome'); stopLocalBeepLoop(); });
$('btnHomePanel') && $('btnHomePanel').addEventListener('click', ()=>{ showView('welcome'); stopLocalBeepLoop(); });

// MODIFICACIÓN: Toggle del botón de alarma local
$('toggleLocalAlarm') && $('toggleLocalAlarm').addEventListener('click', ()=>{ 
    app.localAlarmEnabled = !app.localAlarmEnabled;
    if(!app.localAlarmEnabled) stopLocalBeepLoop(); // Detener alarma inmediatamente si se desactiva
    updateAlarmButton();
});


// Set temp to device
function fetchSetTemp(value){ if(!app.current) return; fetch((app.current.host.startsWith('http')?app.current.host:'http://'+app.current.host) + '/set_temp?value=' + encodeURIComponent(value)).catch(()=>{}); }

// QR scanning (html5-qrcode dynamic load)
let qrScanner = null;
function ensureQrLib(){ return new Promise((resolve,reject)=>{ if(window.Html5Qrcode) return resolve(); const s = document.createElement('script'); s.src = 'https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js'; s.onload = ()=>resolve(); s.onerror = ()=>reject(); document.head.appendChild(s); }); }
/*
// Se comenta la versión anterior de startQrScanner para evitar la redeclaración
async function startQrScanner(){
  if(!window.Html5Qrcode){ $('qrReader') && ($('qrReader').textContent = 'QR loader no disponible.'); return; }
  try{
    qrScanner = new Html5Qrcode("qrReader", { experimentalFeatures: { useBarCodeDetectorIfSupported: true }});
    await qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 260, height: 260 } }, qrMessage => {
      stopQrScanner();
      $('qrReaderHolder') && ($('qrReaderHolder').style.display='none');
      $('modalAdd').classList.remove('show');
      tryAddFromQR(qrMessage);
    });
  }catch(e){
    $('qrReader') && ($('qrReader').textContent = 'No se pudo acceder a la cámara. Usa HTTPS o instala la PWA.');
  }
}
*/
function stopQrScanner(){ if(qrScanner){ qrScanner.stop().then(()=>{ qrScanner.clear(); qrScanner = null; }).catch(()=>{ qrScanner = null; }); } }

// MODIFICACIÓN: Lógica para intentar extraer Alias y Host del QR
function tryAddFromQR(msg){
  if(!msg) return alert('QR vacío');
  const parts = msg.split('|').map(p=>p.trim());
  let host = null, label = null;
  // Se asume formato QR: "Alias|Host" o solo "Host"
  if(parts.length >= 2){ 
    label = parts[0]; 
    host = parts[1];
  } else {
    host = parts[0];
    label = parts[0]; // Usar el host como alias si solo hay un elemento
  }
  app.devices.push({ host: host, label: label || host });
  saveDevices();
  renderDeviceList();
  alert('Dispositivo agregado: ' + (label || host));
}

// startup
(function(){
  app.devices = loadDevices();
  renderDeviceList();
  if(app.devices.length === 1){
    selectDevice(0);
    openPanel();
  }
  updateAlarmButton(); // Inicializar el botón de alarma
})();
</script>

<script>
// === LECTOR QR INTERNO (sin dependencias externas) ===
async function startQrScanner(){
  const holder = document.getElementById('qrReader');
  if(!holder){ alert('No se encontró el lector QR en la interfaz.'); return; }
  holder.innerHTML = 'Activando cámara...';
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }});
    const video = document.createElement('video');
    video.setAttribute('playsinline', true);
    video.srcObject = stream;
    await video.play();
    holder.innerHTML = ''; holder.appendChild(video);
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const detectorOk = ('BarcodeDetector' in window);
    let detector = null;
    if(detectorOk){ try{ detector = new BarcodeDetector({formats:['qr_code']}); }catch(e){ detector = null; } }
    const scan = async()=>{
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        if(detector){
          try{
            const codes = await detector.detect(canvas);
            if(codes.length){ stopQrScanner(video,stream); tryAddFromQR(codes[0].rawValue); return; }
          }catch(e){}
        }
      }
      requestAnimationFrame(scan);
    };
    scan();
  }catch(err){
    console.error('Error de cámara', err);
    holder.innerHTML = 'No se pudo acceder a la cámara. Revisa permisos o HTTPS.';
  }
}
function stopQrScanner(video, stream){
  try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){}
  try{ video.pause(); video.srcObject=null; video.remove(); }catch(e){}
}
</script>

</body>
</html>
